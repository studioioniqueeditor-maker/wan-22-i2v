<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vivid Flow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --bg-color: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent-blue: #0071E3;
            --accent-black: #000000;
            --border-color: #D2D2D7;
            --input-bg: #F5F5F7;
            --radius-md: 12px;
        }

        body { 
            background-color: var(--card-bg);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            width: 100vw;
            margin: 0;
            overflow: hidden;
        }

        .app-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 1.5rem 2rem;
        }

        h1 { font-weight: 700; font-size: 1.4rem; letter-spacing: -0.03em; }
        
        .form-label { 
            color: var(--text-secondary); 
            font-weight: 600; 
            font-size: 0.7rem; 
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
        
        .form-control, .form-select {
            background-color: var(--input-bg);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            padding: 0.5rem 0.8rem;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        .form-control:focus, .form-select:focus {
            background-color: #FFFFFF;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
        }

        .btn-primary {
            background-color: var(--accent-black);
            border: none;
            border-radius: 100px;
            padding: 0.8rem 2rem;
            font-weight: 700;
            font-size: 0.85rem;
        }

        /* Preview Container */
        .preview-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #F2F2F7;
            border-radius: var(--radius-md);
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
        }
        
        .drop-zone-content { text-align: center; color: var(--text-secondary); z-index: 5; }
        .drop-zone-input {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer; z-index: 10;
        }
        .preview-img {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: contain;
            display: none;
            z-index: 6;
            background: #000;
        }

        .toggle-view-btn {
            /* Legacy style replaced by .view-controls button */
            display: none;
        }

        /* Auto-Enhance Button */
        .enhance-toggle-card {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 0.5rem 0.8rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }
        .enhance-toggle-card .title { font-size: 0.75rem; font-weight: 700; }

        /* Enhance Button */
        .prompt-wrapper { position: relative; }
        #enhance-btn {
            position: absolute; 
            top: 50%; 
            right: 8px; 
            transform: translateY(-50%);
            z-index: 15;
            font-size: 0.65rem;
            font-weight: 800;
            padding: 4px 10px;
        }

        /* Animations */
        @keyframes enhance-glow {
            0% { box-shadow: 0 0 0 0 rgba(0, 113, 227, 0.4); }
            50% { box-shadow: 0 0 15px 2px rgba(0, 113, 227, 0.2); }
            100% { box-shadow: 0 0 0 0 rgba(0, 113, 227, 0.4); }
        }
        .enhancing { animation: enhance-glow 1.5s infinite; border-color: var(--accent-blue) !important; }

        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .loading-scan {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(to right, transparent, var(--accent-blue), transparent);
            animation: scanline 2s linear infinite;
            z-index: 35;
        }

        /* Layout */
        .content-row { height: calc(100vh - 100px); }
        .col-scroll {
            height: 100%;
            overflow-y: auto;
            padding-right: 12px;
            scrollbar-width: none;
        }
        .col-scroll::-webkit-scrollbar { display: none; }

        #loading {
            position: absolute;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30;
            color: white;
            backdrop-filter: blur(8px);
        }

        .history-card {
            background: #F9F9F9;
            border-radius: 10px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            border: 1px solid #EEE;
        }
        .history-card:hover { border-color: var(--accent-blue); }

        .badge-pro {
            background: var(--accent-black);
            color: white;
            font-size: 0.6rem;
            font-weight: 800;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            margin-left: 0.4rem;
        }
        
        .mb-3 { margin-bottom: 0.75rem !important; }

        .btn-white {
            background-color: #FFFFFF;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .btn-white:hover {
            background-color: #F5F5F7;
            color: var(--text-primary);
        }
        
        #reset-btn {
            width: 140px;
        }
        
        #reset-btn:hover {
            background-color: #e9ecef;
            color: #000;
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-shrink-0">
            <h1 class="mb-0">Vivid Flow<span class="badge-pro">PRO</span></h1>
            <div class="dropdown">
                <button class="btn btn-light border rounded-pill dropdown-toggle px-3 py-1 d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown">
                    <span class="small fw-semibold">{{ user_email }}</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-4 mt-2">
                    <li><a class="dropdown-item py-2 small" href="/account">Account Settings</a></li>
                    <li><a class="dropdown-item py-2 small" href="/history">History</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><form action="/logout" method="POST" class="m-0"><button type="submit" class="dropdown-item py-2 small text-danger">Log Out</button></form></li>
                </ul>
            </div>
        </div>

        <div class="row g-4 content-row">
            <!-- Left: Controls -->
            <div class="col-lg-5 h-100">
                <div class="col-scroll">
                    <form id="gen-form">
                        <div class="mb-3">
                            <label class="form-label">Model Selection</label>
                            <select class="form-select" id="model" name="model">
                                <option value="wan2.1">Wan 2.1 (RunPod)</option>
                                <option value="veo3.1">Google Veo 3.1 (Vertex AI)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Creative Prompt</label>
                            <div class="prompt-wrapper">
                                <textarea class="form-control" id="prompt" name="prompt" rows="2" required style="padding-right: 85px;" placeholder="A cinematic shot of..."></textarea>
                                <button type="button" id="enhance-btn" class="btn btn-sm btn-white border rounded-pill shadow-sm" style="display: none;">
                                    ‚ú® ENHANCE
                                </button>
                            </div>
                        </div>

                        <!-- Veo Options -->
                        <div id="veo-options" style="display: none;">
                            <input type="hidden" name="camera_motion" id="final_camera_motion">
                            <input type="hidden" name="subject_animation" id="final_subject_animation">
                            <input type="hidden" name="environmental_animation" id="final_environmental_animation">

                            <div class="mb-3">
                                <label class="form-label">Aspect Ratio</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="aspect_ratio" id="aspect_16_9" value="16:9" checked>
                                    <label class="btn btn-outline-secondary" for="aspect_16_9">16:9</label>
                                    <input type="radio" class="btn-check" name="aspect_ratio" id="aspect_9_16" value="9:16">
                                    <label class="btn btn-outline-secondary" for="aspect_9_16">9:16</label>
                                </div>
                            </div>

                            <div class="enhance-toggle-card">
                                <div class="title">Auto-Enhance Prompt</div>
                                <div class="form-check form-switch m-0">
                                    <input class="form-check-input" type="checkbox" role="switch" id="auto_enhance_toggle" name="auto_enhance" value="true">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Camera Movement</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <select class="form-select form-select-sm" id="camera_category">
                                            <option value="None">None</option>
                                            <option value="Dolly">Dolly</option><option value="Zoom">Zoom</option>
                                            <option value="Pan">Pan</option><option value="Vertigo">Vertigo</option>
                                            <option value="OverTheShoulder">OTS</option><option value="POV">POV</option>
                                            <option value="Truck">Truck</option><option value="Tilt">Tilt</option>
                                            <option value="Others">Others</option>
                                        </select>
                                    </div>
                                    <div class="col-6" id="camera_sub_container" style="display: none;">
                                        <select class="form-select form-select-sm" id="camera_sub_option"></select>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Subject Motion</label>
                                <select class="form-select form-select-sm mb-2" id="subject_animation_select">
                                    <option value="None">None</option>
                                    <option value="The subject's head turns slowly">Head turn</option>
                                    <option value="The subject blinks slowly">Blinks</option>
                                    <option value="The subject's hair and clothes flutter gently in the wind">Wind flutter</option>
                                    <option value="A subtle smile appears on the subject's face">Subtle smile</option>
                                    <option value="Other">Other...</option>
                                </select>
                                <input type="text" class="form-control form-control-sm" id="subject_animation_custom" placeholder="Describe motion..." style="display: none;">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Environment</label>
                                <select class="form-select form-select-sm mb-2" id="environmental_animation_select">
                                    <option value="None">None</option>
                                    <option value="Light intensity increases subtly">Light pulse</option>
                                    <option value="Fog rolls in slowly">Fog roll</option>
                                    <option value="Rain starts to fall gently">Gentle rain</option>
                                    <option value="Leaves rustle in the wind">Leaves rustle</option>
                                    <option value="Light changes subtly">Light change</option>
                                    <option value="Reflections move on water">Water movement</option>
                                    <option value="Other">Other...</option>
                                </select>
                                <input type="text" class="form-control form-control-sm" id="environmental_animation_custom" placeholder="Describe environment..." style="display: none;">
                            </div>
                        </div>
                        
                        <div id="wan-options">
                            <div class="mb-3">
                                <label class="form-label">Negative Constraints</label>
                                <textarea class="form-control" id="negative_prompt" name="negative_prompt" rows="2" placeholder="blurry, low quality..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label d-flex justify-content-between">
                                    Motion Scale <span id="cfg-value" class="text-primary fw-bold">7.5</span>
                                </label>
                                <input type="range" class="form-range" id="cfg" name="cfg" min="1.0" max="20.0" step="0.5" value="7.5" oninput="document.getElementById('cfg-value').textContent = this.value">
                            </div>
                        </div>

                        <div class="row g-2 mb-4">
                            <div class="col-6">
                                <label class="form-label">Resolution</label>
                                <select class="form-select form-select-sm" name="resolution">
                                    <option value="1080p">1080p</option>
                                    <option value="720p" selected>720p</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Duration</label>
                                <select class="form-select form-select-sm" name="duration" id="duration-select"></select>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-grow-1" id="generate-btn">
                                CREATE VIDEO
                            </button>
                            <button type="button" class="btn btn-outline-secondary px-4" id="reset-btn" title="Start New">
                                ‚Ü∫ NEW
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right: Preview -->
            <div class="col-lg-7 h-100 d-flex flex-column">
                <div class="preview-container mb-4" id="main-preview-area">
                    <div id="loading">
                        <div class="loading-scan"></div>
                        <div class="spinner-grow text-white mb-3" style="width: 2.5rem; height: 2.5rem;"></div>
                        <div class="fw-bold fs-6">Generating Motion...</div>
                        <div class="small opacity-75 mt-2" id="timer-display">Wait time: ~1 min</div>
                    </div>
                    
                    <!-- Error Toast overlay -->
                    <div id="error-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 28; align-items: center; justify-content: center; flex-direction: column; padding: 2rem; text-align: center;">
                        <div class="text-danger mb-3" style="font-size: 2rem;">‚ö†Ô∏è</div>
                        <h5 class="fw-bold text-danger mb-2">Generation Failed</h5>
                        <p class="small text-secondary mb-4" id="error-message">Unknown error occurred.</p>
                        <button type="button" class="btn btn-sm btn-outline-dark rounded-pill px-4" onclick="document.getElementById('error-overlay').style.display='none'">Dismiss</button>
                    </div>

                    <div class="drop-zone-content" id="drop-zone-ui">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-plus-circle opacity-50 mb-3" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                        </svg>
                        <p class="mb-0 fw-bold small">Source Image</p>
                        <p class="small opacity-50" style="font-size: 0.65rem;">Drop image or click to start</p>
                    </div>
                    <input type="file" id="image-input" name="image" accept="image/*" class="drop-zone-input" form="gen-form">
                    
                    <img id="preview-image" class="preview-img" src="#" alt="Preview">
                    <video id="video-output" controls width="100%" height="100%" style="object-fit: contain; z-index: 20; position: absolute; background:#000; display:none;" autoplay loop>
                        <source src="" type="video/mp4">
                    </video>
                    
                    <div class="view-controls" style="position: absolute; top: 12px; right: 12px; z-index: 25; display: none; gap: 8px;">
                         <button id="show-image-btn" class="btn btn-sm btn-white shadow-sm border rounded-pill fw-bold" style="font-size: 0.75rem;">
                            üëÅÔ∏è View Input
                        </button>
                    </div>
                </div>

                <div class="flex-grow-1 overflow-hidden d-flex flex-column">
                    <h6 class="form-label mb-2">History</h6>
                    <div id="recent-list" class="col-scroll"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const cameraOptions = {
            "Dolly": ["Dolly (In)", "Dolly (Out)"], "Zoom": ["Zoom (In)", "Zoom (Out)"],
            "Pan": ["Pan (left)", "Pan (right)", "Whip Pan"], "Vertigo": ["Vertigo Effect (Dolly Zoom)"],
            "OverTheShoulder": ["Over-the-Shoulder Shot"], "POV": ["POV Shot"],
            "Truck": ["Truck (Left)", "Truck (Right)"], "Tilt": ["Tilt (up)", "Tilt (down)"],
            "Others": ["Eye-Level", "Low-Angle", "High-Angle", "Bird's-Eye", "Top-Down", "Dutch Angle", "Close-Up", "Medium Shot", "Full Shot", "Wide Shot", "Static Shot", "Handheld", "Shaky Cam", "Drone Shot"]
        };

        const els = {
            model: document.getElementById('model'),
            veo: document.getElementById('veo-options'),
            wan: document.getElementById('wan-options'),
            form: document.getElementById('gen-form'),
            load: document.getElementById('loading'),
            enh: document.getElementById('enhance-btn'),
            prom: document.getElementById('prompt'),
            hist: document.getElementById('recent-list'),
            dur: document.getElementById('duration-select'),
            imgIn: document.getElementById('image-input'),
            imgPre: document.getElementById('preview-image'),
            dropUI: document.getElementById('drop-zone-ui'),
            vid: document.getElementById('video-output'),
            tog: document.getElementById('show-image-btn'),
            viewCtrls: document.querySelector('.view-controls'),
            reset: document.getElementById('reset-btn'),
            errOver: document.getElementById('error-overlay'),
            errMsg: document.getElementById('error-message'),
            camCat: document.getElementById('camera_category'),
            camSub: document.getElementById('camera_sub_option'),
            camSubC: document.getElementById('camera_sub_container'),
            fCam: document.getElementById('final_camera_motion'),
            sbS: document.getElementById('subject_animation_select'),
            sbC: document.getElementById('subject_animation_custom'),
            fSb: document.getElementById('final_subject_animation'),
            evS: document.getElementById('environmental_animation_select'),
            evC: document.getElementById('environmental_animation_custom'),
            fEv: document.getElementById('final_environmental_animation'),
            timer: document.getElementById('timer-display')
        };

        // --- Init ---
        const saved = localStorage.getItem('selectedModel') || 'wan2.1';
        els.model.value = saved;

        // Check for error from server-side render
        {% if error %}
        els.errMsg.textContent = "{{ error }}";
        els.errOver.style.display = 'flex';
        {% endif %}

        function updateUI() {
            const m = els.model.value;
            localStorage.setItem('selectedModel', m);
            els.veo.style.display = m === 'veo3.1' ? 'block' : 'none';
            els.wan.style.display = m === 'wan2.1' ? 'block' : 'none';
            els.timer.textContent = `Wait time: ${m === 'veo3.1' ? '~1 min' : '~5 mins'}`;
            els.dur.innerHTML = (m === 'veo3.1' ? [4, 6, 8] : [5, 3]).map(o => `<option value="${o}" ${o==4||o==5?'selected':''}>${o}s</option>`).join('');
        }
        els.model.addEventListener('change', updateUI);
        updateUI();

        // --- Select Logic ---
        els.camCat.addEventListener('change', () => {
            const cat = els.camCat.value; els.camSub.innerHTML = '';
            if(cat === 'None') { els.camSubC.style.display='none'; els.fCam.value='None'; }
            else { 
                cameraOptions[cat].forEach(o => els.camSub.add(new Option(o,o)));
                els.camSubC.style.display='block'; els.fCam.value=els.camSub.value;
            }
        });
        els.camSub.addEventListener('change', () => els.fCam.value = els.camSub.value);

        function bindCustom(s,c,f) {
            const u = () => { if(s.value==='Other'){c.style.display='block'; f.value=c.value;}else{c.style.display='none'; f.value=s.value;} };
            s.onchange = u; c.oninput = () => f.value = c.value; u();
        }
        bindCustom(els.sbS, els.sbC, els.fSb); bindCustom(els.evS, els.evC, els.fEv);

        // --- Previews ---
        els.imgIn.onchange = () => {
            const f = els.imgIn.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = e => { 
                    els.imgPre.src=e.target.result; 
                    els.imgPre.style.display='block'; 
                    els.dropUI.style.display='none'; 
                    els.vid.style.display='none';
                    els.viewCtrls.style.display='none';
                    els.errOver.style.display='none';
                };
                r.readAsDataURL(f);
            }
        };

        els.tog.onclick = () => {
            const isVid = els.vid.style.display !== 'none';
            els.vid.style.display = isVid ? 'none' : 'block';
            els.imgPre.style.display = isVid ? 'block' : 'none';
            els.tog.textContent = isVid ? 'üé¨ View Result' : 'üëÅÔ∏è View Input';
        };

        els.reset.onclick = () => {
            els.form.reset();
            els.imgPre.src = '#';
            els.imgPre.style.display = 'none';
            els.vid.style.display = 'none';
            els.vid.src = '';
            els.dropUI.style.display = 'block';
            els.viewCtrls.style.display = 'none';
            els.prom.style.height = 'auto';
            els.prom.rows = 2;
            els.errOver.style.display = 'none';
            updateUI(); // Reset dynamic fields
        };

        // --- Actions ---
        els.form.onsubmit = async e => {
            e.preventDefault(); 
            els.load.style.display='flex';
            els.errOver.style.display='none';
            els.form.style.opacity='0.4'; els.form.style.pointerEvents='none';
            const fd = new FormData(els.form);
            try {
                const res = await fetch('/generate', { 
                    method:'POST', 
                    body:fd,
                    headers: { 'Accept': 'application/json' }
                });
                const data = await res.json();
                if(!res.ok) throw new Error(data.message || 'Generation Error');
                
                // Update Video
                els.vid.src = data.video_url;
                els.vid.style.display = 'block';
                els.imgPre.style.display = 'none';
                els.viewCtrls.style.display = 'flex';
                els.tog.textContent = 'üëÅÔ∏è View Input';
                
                loadHistory(); // Refresh history list
            } catch(err) { 
                els.errMsg.textContent = err.message;
                els.errOver.style.display = 'flex';
            } finally {
                els.load.style.display='none'; 
                els.form.style.opacity='1'; 
                els.form.style.pointerEvents='auto';
            }
        };

        els.enh.onclick = async () => {
            if(!els.prom.value) return alert('Enter prompt');
            els.enh.disabled = true; els.prom.classList.add('enhancing');
            const fd = new FormData(els.form);
            try {
                const res = await fetch('/enhance_prompt', { method:'POST', body:fd });
                const d = await res.json(); 
                if(d.enhanced_prompt) {
                    els.prom.value = d.enhanced_prompt;
                    els.prom.rows = 4; // Expand prompt box
                }
            } catch(e){} finally { els.enh.disabled=false; els.prom.classList.remove('enhancing'); }
        };

        async function loadHistory() {
            try {
                const res = await fetch('/api/history');
                const data = await res.json();
                if(!data || data.length === 0) {
                    els.hist.innerHTML = '<div class="text-center opacity-30 py-5 small fw-bold">NO GENERATIONS YET</div>';
                } else {
                    els.hist.innerHTML = data.slice(0, 10).map(i => `
                        <div class="history-card" onclick="window.location.href='${i.video_url}'">
                            <div class="d-flex align-items-center gap-3">
                                <div style="width:40px; height:24px; background:#000; border-radius:4px; overflow:hidden;">
                                    <video muted style="width:100%; height:100%; object-fit:cover;"><source src="${i.video_url}"></video>
                                </div>
                                <div class="text-truncate small fw-medium" style="max-width:300px;">${i.prompt}</div>
                            </div>
                        </div>`).join('');
                }
            } catch(e){}
        }
        loadHistory();
    </script>
</body>
</html>